<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 深入解析 composer 的自动加载原理 · Code for freedom</title><meta name="description" content="深入解析 composer 的自动加载原理 - Jeffrey"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.tenpercent.top/atom.xml" title="Code for freedom"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon1.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about-me.html" target="_self" class="nav-list-link">关于</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">深入解析 composer 的自动加载原理</h1><div class="post-info">May 17, 2018</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>PHP 自5.3的版本之后，已经重焕新生，命名空间、性状（trait）、闭包、接口、PSR 规范、以及 composer 的出现已经让 PHP 变成了一门现代化的脚本语言。PHP 的生态系统也一直在演进，而 composer 的出现更是彻底的改变了以往构建 PHP 应用的方式，我们可以根据 PHP 的应用需求混合搭配最合适的 PHP 组件。当然这也得益于 PSR 规范的提出。</p>
<h3 id="掌握-composer-自动加载原理的好处"><a href="#掌握-composer-自动加载原理的好处" class="headerlink" title="掌握 composer 自动加载原理的好处"></a>掌握 composer 自动加载原理的好处</h3><ul>
<li><p>更好的运用 composer 来构建我们的 PHP 应用程序</p>
</li>
<li><p>对 PSR 规范有进一步的了解</p>
</li>
<li><p>当需要用到没有 composer 化的第三方库时，可以将其 composer 化来提高工程效率</p>
</li>
<li><p>学习比较严谨、高深的编码技巧</p>
</li>
</ul>
<a id="more"></a>
<hr>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>PHP 自动加载功能</li>
<li>PSR 规范</li>
<li>comoposer 的自动加载过程</li>
<li>composer 源码分析</li>
</ul>
<hr>
<h2 id="一、PHP-自动加载功能"><a href="#一、PHP-自动加载功能" class="headerlink" title="一、PHP 自动加载功能"></a>一、PHP 自动加载功能</h2><h3 id="PHP-自动加载功能的由来"><a href="#PHP-自动加载功能的由来" class="headerlink" title="PHP 自动加载功能的由来"></a>PHP 自动加载功能的由来</h3><p>在 PHP 开发过程中，如果希望从外部引入一个 Class ，通常会使用 <code>include</code> 和 <code>require</code> 方法，去把定义这个 Class 的文件包含进来。这个在小规模开发的时候，没什么大问题。但在大型的开发项目中，使用这种方式会带来一些隐含的问题：如果一个 PHP 文件需要使用很多其它类，那么就需要很多的 <code>require/include</code> 语句，这样有可能会 <strong>造成遗漏</strong> 或者 <strong>包含进不必要的类文件</strong>。如果大量的文件都需要使用其它的类，那么要保证每个文件都包含正确的类文件肯定是一个噩梦， 况且 require或 incloud 的性能代价很大。</p>
<p>PHP5 为这个问题提供了一个解决方案，这就是 <code>类的自动加载(autoload)机制</code>。<code>autoload机制</code> 可以使得 PHP 程序有可能在使用类时才自动包含类文件，而不是一开始就将所有的类文件<code>include</code>进来，这种机制也称为 <code>Lazy loading (惰性加载)</code>。</p>
<ul>
<li><p>总结起来，自动加载功能带来了几处优点：</p>
<blockquote>
<ol>
<li>使用类之前无需 <code>include / require</code></li>
<li>使用类的时候才会 <code>include / require</code> 文件，实现了 <code>lazy loading</code> ，避免了 <code>include / require</code> 多余文件。</li>
<li>无需考虑引入 <strong>类的实际磁盘地址</strong> ，实现了逻辑和实体文件的分离。</li>
</ol>
</blockquote>
</li>
</ul>
<h3 id="PHP-自动加载函数-autoload"><a href="#PHP-自动加载函数-autoload" class="headerlink" title="PHP 自动加载函数 __autoload()"></a>PHP 自动加载函数 __autoload()</h3><ul>
<li><p>通常 PHP5 在使用一个类时，如果发现这个类没有加载，就会自动运行 __autoload() 函数，这个函数是我们在程序中自定义的，在这个函数中我们可以加载需要使用的类。下面是个简单的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($classname)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">require_once</span> ($classname . <span class="string">".class.php"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在我们这个简单的例子中，我们直接将类名加上扩展名 <code>.class.php</code> 构成了类文件名，然后使用 <code>require_once</code> 将其加载。</p>
<blockquote>
<p>从这个例子中，我们可以看出 __autoload 至少要做三件事情：</p>
</blockquote>
<blockquote>
<ol>
<li><p>根据类名确定类文件名；</p>
</li>
<li><p>确定类文件所在的磁盘路径；</p>
</li>
<li><p>将类从磁盘文件中加载到系统中。</p>
</li>
</ol>
</blockquote>
</li>
</ul>
<ul>
<li><p>第三步最简单，只需要使用 <code>include / require</code> 即可。要实现第一步，第二步的功能，必须在开发时约定类名与磁盘文件的映射方法，只有这样我们才能根据类名找到它对应的磁盘文件。</p>
</li>
<li><p>当有大量的类文件要包含的时候，我们只要确定相应的规则，然后在 <strong><code>__autoload()</code> 函数中，将类名与实际的磁盘文件对应起来，就可以实现 <code>lazy loading</code> 的效果</strong> 。</p>
</li>
<li>如果想详细的了解关于 autoload 自动加载的过程，可以查看手册资料：<a href="http://php.net/manual/zh/function.autoload.php" target="_blank" rel="noopener">PHP autoload函数说明</a></li>
</ul>
<h2 id="autoload-函数存在的问题"><a href="#autoload-函数存在的问题" class="headerlink" title="__autoload() 函数存在的问题"></a>__autoload() 函数存在的问题</h2><ul>
<li><p>如果在一个系统的实现中，如果需要使用很多其它的类库，这些类库可能是由不同的开发人员编写的，  其类名与实际的磁盘文件的映射规则不尽相同。这时如果要实现类库文件的自动加载，就必须 <strong>在 __autoload() 函数中将所有的映射规则全部实现</strong>，这样的话 <code>__autoload()</code> 函数有可能会非常复杂，甚至无法实现。最后可能会导致 <code>__autoload()</code> 函数十分臃肿，这时即便能够实现，也会给将来的维护和系统效率带来很大的负面影响。</p>
</li>
<li><p>那么问题出现在哪里呢？问题出现在 <strong>__autoload() 是全局函数只能定义一次</strong> ，不够灵活，所以所有的类名与文件名对应的逻辑规则都要在一个函数里面实现，造成这个函数的臃肿。那么如何来解决这个问题呢？答案就是使用一个 <strong>__autoload调用堆栈</strong> ，不同的映射关系写到不同的 <code>__autoload函数</code> 中去，然后统一注册统一管理，这个就是 PHP5 引入的 <code>SPL Autoload</code> 。</p>
</li>
</ul>
<h3 id="SPL-Autoload"><a href="#SPL-Autoload" class="headerlink" title="SPL Autoload"></a>SPL Autoload</h3><ul>
<li>SPL是 Standard PHP Library(标准PHP库)的缩写。它是 PHP5 引入的一个扩展标准库，包括 spl autoload 相关的函数以及各种数据结构和迭代器的接口或类。spl autoload 相关的函数具体可见 <a href="http://php.net/manual/zh/function.spl-autoload-register.php" target="_blank" rel="noopener">php中spl_autoload</a></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// __autoload 函数</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// function __autoload($class) &#123;</span></span><br><span class="line"><span class="comment">//     include 'classes/' . $class . '.class.php';</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">my_autoloader</span><span class="params">($class)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">'classes/'</span> . $class . <span class="string">'.class.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spl_autoload_register(<span class="string">'my_autoloader'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义的 autoload 函数在 class 里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'MyClass'</span>, <span class="string">'autoload'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非静态方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$instance = <span class="keyword">new</span> MyClass();</span><br><span class="line">spl_autoload_register(<span class="keyword">array</span>($instance, <span class="string">'autoload'</span>));</span><br></pre></td></tr></table></figure>
<p>spl_autoload_register() 就是我们上面所说的__autoload调用堆栈，我们可以向这个函数注册多个我们自己的 autoload() 函数，当 PHP 找不到类名时，PHP就会调用这个堆栈，然后去调用自定义的 autoload() 函数，实现自动加载功能。如果我们不向这个函数输入任何参数，那么就会默认注册 spl_autoload() 函数。</p>
<hr>
<h2 id="二、PSR-规范"><a href="#二、PSR-规范" class="headerlink" title="二、PSR 规范"></a>二、PSR 规范</h2><p>与自动加载相关的规范是 PSR4，在说 PSR4 之前先介绍一下PSR标准。PSR 标准的发明和推出组织是：PHP-FIG，它的网站是：<a href="www.php-fig.org">www.php-fig.org</a>。由几位开源框架的开发者成立于 2009 年，从那开始也选取了很多其他成员进来，虽然不是 “官方” 组织，但也代表了社区中不小的一块。组织的目的在于：以最低程度的限制，来统一各个项目的编码规范，避免各家自行发展的风格阻碍了程序员开发的困扰，于是大伙发明和总结了 PSR，PSR是 PHP Standards Recommendation 的缩写，截止到目前为止，总共有 14 套 PSR 规范，其中有 7 套PSR规范已通过表决并推出使用，分别是：</p>
<blockquote>
<p>PSR-0 <strong>自动加载标准</strong>（已废弃，一些旧的第三方库还有在使用）</p>
</blockquote>
<blockquote>
<p>PSR-1 <strong>基础编码标准</strong></p>
</blockquote>
<blockquote>
<p>PSR-2 <strong>编码风格向导</strong></p>
</blockquote>
<blockquote>
<p>PSR-3 <strong>日志接口</strong></p>
</blockquote>
<blockquote>
<p>PSR-4 <strong>自动加载的增强版，替换掉了 PSR-0</strong></p>
</blockquote>
<blockquote>
<p>PSR-6 <strong>缓存接口规范</strong></p>
</blockquote>
<blockquote>
<p>PSR-7 <strong>HTTP 消息接口规范</strong></p>
</blockquote>
<p>具体详细的规范标准可以查看<a href="https://psr.phphub.org/" target="_blank" rel="noopener">PHP 标准规范</a></p>
<h2 id="PSR4-标准"><a href="#PSR4-标准" class="headerlink" title="PSR4 标准"></a>PSR4 标准</h2><p>2013 年底，PHP-FIG 推出了第 5 个规范——PSR-4。</p>
<p>PSR-4 规范了如何指定文件路径从而自动加载类定义，同时规范了自动加载文件的位置。 </p>
<h4 id="1）一个完整的类名需具有以下结构："><a href="#1）一个完整的类名需具有以下结构：" class="headerlink" title="1）一个完整的类名需具有以下结构："></a>1）一个完整的类名需具有以下结构：</h4><p><code>\&lt;命名空间&gt;\&lt;子命名空间&gt;\&lt;类名&gt;</code></p>
<ul>
<li><p>完整的类名<strong>必须</strong>要有一个顶级命名空间，被称为 “vendor namespace”；</p>
</li>
<li><p>完整的类名<strong>可以</strong>有一个或多个子命名空间；</p>
</li>
<li><p>完整的类名<strong>必须</strong>有一个最终的类名；</p>
</li>
<li><p>完整的类名中<strong>任意一部分</strong>中的下滑线都是没有特殊含义的；</p>
</li>
<li><p>完整的类名<strong>可以</strong>由任意大小写字母组成；</p>
</li>
<li><p>所有类名都<strong>必须</strong>是大小写敏感的。</p>
</li>
</ul>
<h5 id="2）根据完整的类名载入相应的文件"><a href="#2）根据完整的类名载入相应的文件" class="headerlink" title="2）根据完整的类名载入相应的文件"></a>2）根据完整的类名载入相应的文件</h5><ul>
<li><p>完整的类名中，去掉最前面的命名空间分隔符，前面连续的一个或多个命名空间和子命名空间，作为「命名空间前缀」，其必须与至少一个「文件基目录」相对应；</p>
</li>
<li><p>紧接命名空间前缀后的子命名空间 必须 与相应的「文件基目录」相匹配，其中的命名空间分隔符将作为目录分隔符。</p>
</li>
<li><p>末尾的类名<strong>必须</strong>与对应的以 .php 为后缀的文件同名。</p>
</li>
<li><p>自动加载器（autoloader）的实现<strong>一定不可</strong>抛出异常、<strong>一定不可</strong>触发任一级别的错误信息以及<strong>不应该</strong>有返回值。</p>
</li>
</ul>
<h4 id="3-例子"><a href="#3-例子" class="headerlink" title="3) 例子"></a>3) 例子</h4><p>PSR-4风格</p>
<blockquote>
<p>类名：\Zend\Abc<br>命名空间前缀：Zend<br>文件基目录：/usr/includes/Zend/<br>文件路径：/usr/includes/Zend/Abc.php</p>
</blockquote>
<blockquote>
<p>类名：\Symfony\Core\Request<br>命名空间前缀：Symfony\Core<br>文件基目录：./vendor/Symfony/Core/<br>文件路径：./vendor/Symfony/Core/Request.php</p>
</blockquote>
<p>目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-vendor/</span><br><span class="line">| -vendor_name/</span><br><span class="line">| | -package_name/</span><br><span class="line">| | | -src/</span><br><span class="line">| | | | -ClassName.php       # Vendor_Name\Package_Name\ClassName</span><br><span class="line">| | | -tests/</span><br><span class="line">| | | | -ClassNameTest.php   # Vendor_Name\Package_Name\ClassNameTest</span><br></pre></td></tr></table></figure>
<h2 id="Composer自动加载过程"><a href="#Composer自动加载过程" class="headerlink" title="Composer自动加载过程"></a>Composer自动加载过程</h2><h4 id="Composer-做了哪些事情"><a href="#Composer-做了哪些事情" class="headerlink" title="Composer 做了哪些事情"></a>Composer 做了哪些事情</h4><ul>
<li>你有一个项目依赖于若干个库。</li>
<li>其中一些库依赖于其他库。</li>
<li>你声明你所依赖的东西。</li>
<li>Composer 会找出哪个版本的包需要安装，并安装它们（将它们下载到你的项目中）。</li>
</ul>
<p>例如，你正在创建一个项目，需要做一些单元测试。你决定使用 <code>phpunit</code> 。为了将它添加到你的项目中，你所需要做的就是在 <code>composer.json</code> 文件里描述项目的依赖关系。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"require"</span>: &#123;</span><br><span class="line">    <span class="string">"phpunit/phpunit"</span>:<span class="string">"~6.0"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>composer require</code> 之后我们只要在项目里面直接 <code>use</code> phpunit 的类即可使用。</p>
<h4 id="执行-composer-require-时发生了什么"><a href="#执行-composer-require-时发生了什么" class="headerlink" title="执行 composer require 时发生了什么"></a>执行 composer require 时发生了什么</h4><ul>
<li>composer 会找到符合 PR4 规范的第三方库的源</li>
<li>将其加载到 vendor 目录下</li>
<li>初始化顶级域名的映射并写入到指定的文件里<br>（如：<code>&#39;PHPUnit\\Framework\\Assert&#39; =&gt; __DIR__ . &#39;/..&#39; . &#39;/phpunit/phpunit/src/Framework/Assert.php&#39;</code>）</li>
<li>写好一个 autoload 函数，并且注册到 spl_autoload_register()里</li>
</ul>
<p><em>题外话：现在很多框架都已经帮我们写好了顶级域名映射了，我们只需要在框架里面新建文件，在新建的文件中写好命名空间，就可以在任何地方 use 我们的命名空间了。</em></p>
<hr>
<h2 id="Composer-源码分析"><a href="#Composer-源码分析" class="headerlink" title="Composer 源码分析"></a>Composer 源码分析</h2><p>下面我们通过对源码的分析来看看 composer 是如何实现 <code>PSR4标准</code> 的自动加载功能。</p>
<p>很多框架在初始化的时候都会引入 composer 来协助自动加载的，以 Laravel 为例，它入口文件 index.php 第一句就是利用 composer 来实现自动加载功能。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  define(<span class="string">'LARAVEL_START'</span>, microtime(<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br></pre></td></tr></table></figure>
<p>去 vendor 目录下的 <code>autoload.php</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer'</span> . <span class="string">'/autoload_real.php'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29::getLoader();</span><br></pre></td></tr></table></figure>
<p>这里就是 Composer 真正开始的地方了</p>
<h3 id="Composer自动加载文件"><a href="#Composer自动加载文件" class="headerlink" title="Composer自动加载文件"></a>Composer自动加载文件</h3><p>首先，我们先大致了解一下Composer自动加载所用到的源文件。</p>
<blockquote>
<ol>
<li>autoload_real.php: 自动加载功能的引导类。<ul>
<li>composer 加载类的初始化<code>(顶级命名空间与文件路径映射初始化)</code>和注册(spl_autoload_register())。</li>
</ul>
</li>
<li>ClassLoader.php : composer 加载类。<ul>
<li>composer 自动加载功能的核心类。</li>
</ul>
</li>
<li>autoload_static.php : 顶级命名空间初始化类，<ul>
<li>用于给核心类初始化顶级命名空间。</li>
</ul>
</li>
<li>autoload_classmap.php : 自动加载的最简单形式，<ul>
<li>有完整的命名空间和文件目录的映射；</li>
</ul>
</li>
<li>autoload_files.php : 用于加载全局函数的文件，<ul>
<li>存放各个全局函数所在的文件路径名；</li>
</ul>
</li>
<li>autoload_namespaces.php : 符合 PSR0 标准的自动加载文件，<ul>
<li>存放着顶级命名空间与文件的映射；</li>
</ul>
</li>
<li>autoload_psr4.php : 符合 PSR4 标准的自动加载文件，<ul>
<li>存放着顶级命名空间与文件的映射；</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="autoload-real-引导类"><a href="#autoload-real-引导类" class="headerlink" title="autoload_real 引导类"></a>autoload_real 引导类</h3><hr>
<p>在 vendor 目录下的 <code>autoload.php</code> 文件中我们可以看出，程序主要调用了引导类的静态方法 <code>getLoader()</code> ，我们接着看看这个函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	  <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">	      <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  spl_autoload_register(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line"></span><br><span class="line">	  spl_autoload_unregister(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">	  $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; !defined(<span class="string">'HHVM_VERSION'</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">	      <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</span><br><span class="line"></span><br><span class="line">	      call_user_func(</span><br><span class="line">          \Composer\Autoload\ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::getInitializer($loader)</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">	  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	      $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line">	      <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">	          $loader-&gt;set($namespace, $path);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	      $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">	      <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">	          $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	      $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line">	      <span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">	          $loader-&gt;addClassMap($classMap);</span><br><span class="line">	      &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/***********************注册自动加载核心类对象********************/</span></span><br><span class="line">	  $loader-&gt;register(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/***********************自动加载全局函数********************/</span></span><br><span class="line">	  <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">	      $includeFiles = Composer\Autoload\ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$files;</span><br><span class="line">	  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	      $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">	      composerRequire7b790917ce8899df9af8ed53631a1c29($fileIdentifier, $file);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">return</span> $loader;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我把自动加载引导类分为 5 个部分。</p>
<h3 id="第一部分——单例"><a href="#第一部分——单例" class="headerlink" title="第一部分——单例"></a>第一部分——单例</h3><p>第一部分很简单，就是个最经典的单例模式，自动加载类只能有一个。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="第二部分——构造ClassLoader核心类"><a href="#第二部分——构造ClassLoader核心类" class="headerlink" title="第二部分——构造ClassLoader核心类"></a>第二部分——构造ClassLoader核心类</h3><p>第二部分 new 一个自动加载的核心类对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">/***********************获得自动加载核心类对象********************/</span></span><br><span class="line">  spl_autoload_register(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line"></span><br><span class="line">  spl_autoload_unregister(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>)</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p><code>loadClassLoader()</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === $class) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/ClassLoader.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从程序里面我们可以看出，composer 先向 PHP 自动加载机制注册了一个函数，这个函数 require 了 ClassLoader 文件。成功 new 出该文件中核心类 ClassLoader() 后，又销毁了该函数。</p>
<h3 id="第三部分-——-初始化核心类对象"><a href="#第三部分-——-初始化核心类对象" class="headerlink" title="第三部分 —— 初始化核心类对象"></a>第三部分 —— 初始化核心类对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">/***********************初始化自动加载核心类对象********************/</span></span><br><span class="line">  $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; !defined(<span class="string">'HHVM_VERSION'</span>);</span><br><span class="line">  <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">     <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</span><br><span class="line"></span><br><span class="line">     call_user_func(</span><br><span class="line">       \Composer\Autoload\ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::getInitializer($loader)</span><br><span class="line">     );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line">      <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">         $loader-&gt;set($namespace, $path);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">      <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">         $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line">      <span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">          $loader-&gt;addClassMap($classMap);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> 这一部分就是对自动加载类的初始化，主要是给自动加载核心类初始化顶级命名空间映射。</p>
<p>   初始化的方法有两种：</p>
<pre><code>1. 使用 autoload_static 进行静态初始化；
2. 调用核心类接口初始化。
</code></pre><h3 id="autoload-static-静态初始化-PHP-gt-5-6"><a href="#autoload-static-静态初始化-PHP-gt-5-6" class="headerlink" title="autoload_static 静态初始化 ( PHP &gt;= 5.6 )"></a>autoload_static 静态初始化 ( PHP &gt;= 5.6 )</h3><p>静态初始化只支持 PHP5.6 以上版本并且不支持 HHVM 虚拟机。我们深入 <code>autoload_static.php</code> 这个文件发现这个文件定义了一个用于静态初始化的类，名字叫 <code>ComposerStaticInit7b790917ce8899df9af8ed53631a1c29</code>，仍然为了避免冲突而加了 hash 值。这个类很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ComposerStaticInit7b790917ce8899df9af8ed53631a1c29</span></span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> $files = <span class="keyword">array</span>(...);</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span>(...);</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span>(...);</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> $prefixesPsr0 = <span class="keyword">array</span>(...);</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInitializer</span><span class="params">(ClassLoader $loader)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> \Closure::bind(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($loader)</span> </span>&#123;</span><br><span class="line">          $loader-&gt;prefixLengthsPsr4</span><br><span class="line">  						= ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$prefixLengthsPsr4;</span><br><span class="line"></span><br><span class="line">          $loader-&gt;prefixDirsPsr4</span><br><span class="line">  						= ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$prefixDirsPsr4;</span><br><span class="line"></span><br><span class="line">          $loader-&gt;prefixesPsr0</span><br><span class="line">  						= ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$prefixesPsr0;</span><br><span class="line"></span><br><span class="line">          $loader-&gt;classMap</span><br><span class="line">  						= ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$classMap;</span><br><span class="line"></span><br><span class="line">      &#125;, <span class="keyword">null</span>, ClassLoader::class);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这个静态初始化类的核心就是 <code>getInitializer()</code> 函数，它将自己类中的顶级命名空间映射给了 ClassLoader 类。值得注意的是这个函数返回的是一个匿名函数，为什么呢？原因就是 <code>ClassLoader类</code> 中的 <code>prefixLengthsPsr4</code> 、<code>prefixDirsPsr4</code>等等变量都是 private的。利用匿名函数的绑定功能就可以将这些 private 变量赋给 ClassLoader 类 里的成员变量。</p>
<p>关于匿名函数的<a href="http://php.net/manual/zh/closure.bind.php" target="_blank" rel="noopener">绑定功能</a>。</p>
<p>接下来就是命名空间初始化的关键了。</p>
<h4 id="classMap（命名空间映射）"><a href="#classMap（命名空间映射）" class="headerlink" title="classMap（命名空间映射）"></a>classMap（命名空间映射）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (</span><br><span class="line">  	<span class="string">'App\\Console\\Kernel'</span></span><br><span class="line">  			=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Console/Kernel.php'</span>,</span><br><span class="line"></span><br><span class="line">  	<span class="string">'App\\Exceptions\\Handler'</span></span><br><span class="line">  			=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Exceptions/Handler.php'</span>,</span><br><span class="line"></span><br><span class="line">  	<span class="string">'App\\Http\\Controllers\\Auth\\ForgotPasswordController'</span></span><br><span class="line">  			=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/ForgotPasswordController.php'</span>,</span><br><span class="line"></span><br><span class="line">  	<span class="string">'App\\Http\\Controllers\\Auth\\LoginController'</span></span><br><span class="line">  			=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/LoginController.php'</span>,</span><br><span class="line"></span><br><span class="line">  	<span class="string">'App\\Http\\Controllers\\Auth\\RegisterController'</span></span><br><span class="line">  			=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/RegisterController.php'</span>,</span><br><span class="line">  ...)</span><br></pre></td></tr></table></figure>
<p>直接命名空间全名与目录的映射，简单粗暴，也导致这个数组相当的大。</p>
<h4 id="PSR4-标准顶级命名空间映射数组："><a href="#PSR4-标准顶级命名空间映射数组：" class="headerlink" title="PSR4 标准顶级命名空间映射数组："></a>PSR4 标准顶级命名空间映射数组：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span>(</span><br><span class="line">  	<span class="string">'p'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">		<span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; <span class="number">25</span>,</span><br><span class="line">	),</span><br><span class="line">  	<span class="string">'S'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">		<span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="number">26</span>,</span><br><span class="line">		<span class="string">'Symfony\\Component\\Yaml\\'</span> =&gt; <span class="number">23</span>,</span><br><span class="line">		<span class="string">'Symfony\\Component\\VarDumper\\'</span> =&gt; <span class="number">28</span>,</span><br><span class="line">		...</span><br><span class="line">	),</span><br><span class="line">  ...);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span> (</span><br><span class="line">  	<span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">		<span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-common/src'</span>,</span><br><span class="line">		<span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/type-resolver/src'</span>,</span><br><span class="line">		<span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-docblock/src'</span>,</span><br><span class="line">	),</span><br><span class="line">  	 <span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">		<span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring'</span>,</span><br><span class="line">	),</span><br><span class="line">  	<span class="string">'Symfony\\Component\\Yaml\\'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">		<span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/yaml'</span>,</span><br><span class="line">	),</span><br><span class="line">  ...)</span><br></pre></td></tr></table></figure>
<p>PSR4 标准顶级命名空间映射用了两个数组，第一个是用命名空间第一个字母作为前缀索引，然后是 顶级命名空间，但是最终并不是文件路径，而是 顶级命名空间的长度。为什么呢？</p>
<p>因为 PSR4 标准是用顶级命名空间目录替换顶级命名空间，所以获得顶级命名空间的长度很重要。</p>
<p>具体说明这些数组的作用：</p>
<p>假如我们找 <code>Symfony\Polyfill\Mbstring\example</code> 这个命名空间，通过前缀索引和字符串匹配我们得到了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="number">26</span>,</span><br></pre></td></tr></table></figure>
<p>这条记录，键是顶级命名空间，值是命名空间的长度。拿到顶级命名空间后去 <code>$prefixDirsPsr4数组</code> 获取它的映射目录数组：<strong>(注意映射目录可能不止一条)</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="keyword">array</span> (</span><br><span class="line">  	        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring'</span>,</span><br><span class="line">  	    )</span><br></pre></td></tr></table></figure>
<p>然后我们就可以将命名空间 <code>Symfony\\Polyfill\\Mbstring\\example</code> 前26个字符替换成目录 <code>__DIR__ . &#39;/..&#39; . &#39;/symfony/polyfill-mbstring</code> ，我们就得到了<code>__DIR__ . &#39;/..&#39; . &#39;/symfony/polyfill-mbstring/example.php</code>，先验证磁盘上这个文件是否存在，如果不存在接着遍历。如果遍历后没有找到，则加载失败。</p>
<h3 id="ClassLoader-接口初始化（-PHP-lt-5-6-）"><a href="#ClassLoader-接口初始化（-PHP-lt-5-6-）" class="headerlink" title="ClassLoader 接口初始化（ PHP &lt; 5.6 ）"></a>ClassLoader 接口初始化（ PHP &lt; 5.6 ）</h3><hr>
<p>如果PHP版本低于 5.6 或者使用 HHVM 虚拟机环境，那么就要使用核心类的接口进行初始化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">// PSR0 标准</span></span><br><span class="line">	$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line">	<span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">	   $loader-&gt;set($namespace, $path);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PSR4 标准</span></span><br><span class="line">	$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">	<span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">	   $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line">	<span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">	   $loader-&gt;addClassMap($classMap);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="PSR4-标准的映射"><a href="#PSR4-标准的映射" class="headerlink" title="PSR4 标准的映射"></a>PSR4 标准的映射</h4><p>autoload_psr4.php 的顶级命名空间映射</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'XdgBaseDir\\'</span></span><br><span class="line">		=&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/dnoegel/php-xdg-base-dir/src'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'Webmozart\\Assert\\'</span></span><br><span class="line">		=&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/webmozart/assert/src'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'TijsVerkoyen\\CssToInlineStyles\\'</span></span><br><span class="line">		=&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/tijsverkoyen/css-to-inline-styles/src'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'Tests\\'</span></span><br><span class="line">		=&gt; <span class="keyword">array</span>($baseDir . <span class="string">'/tests'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'Symfony\\Polyfill\\Mbstring\\'</span></span><br><span class="line">		=&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/symfony/polyfill-mbstring'</span>),</span><br><span class="line">    ...</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>PSR4 标准的初始化接口:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPsr4</span><span class="params">($prefix, $paths)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	    <span class="keyword">if</span> (!$prefix) &#123;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;fallbackDirsPsr4 = (<span class="keyword">array</span>) $paths;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	        $length = strlen($prefix);</span><br><span class="line">	        <span class="keyword">if</span> (<span class="string">'\\'</span> !== $prefix[$length - <span class="number">1</span>]) &#123;</span><br><span class="line">	            <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(</span><br><span class="line">                  <span class="string">"A non-empty PSR-4 prefix must end with a namespace separator."</span></span><br><span class="line">                );</span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$prefix[<span class="number">0</span>]][$prefix] = $length;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;prefixDirsPsr4[$prefix] = (<span class="keyword">array</span>) $paths;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>PSR4初始化接口也很简单。如果没有顶级命名空间，就直接保存目录。如果有命名空间的话，要保证顶级命名空间最后是 <code>\</code> ，然后分别保存。</p>
<p>总结下上面的顶级命名空间映射过程：</p>
<pre><code>( 前缀 -&gt; 顶级命名空间，顶级命名空间 -&gt; 顶级命名空间长度 )
( 顶级命名空间 -&gt; 目录 )
</code></pre><p>这两个映射数组。具体形式也可以查看下面的 <code>autoload_static</code> 的 prefixLengthsPsr4 、 $prefixDirsPsr4 。</p>
<h4 id="命名空间映射"><a href="#命名空间映射" class="headerlink" title="命名空间映射"></a>命名空间映射</h4><p>autoload_classmap：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'App\\Console\\Kernel'</span></span><br><span class="line">		=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Console/Kernel.php'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">'App\\Exceptions\\Handler'</span></span><br><span class="line">		=&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Exceptions/Handler.php'</span>,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>addClassMap:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addClassMap</span><span class="params">(array $classMap)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;classMap) &#123;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;classMap = array_merge(<span class="keyword">$this</span>-&gt;classMap, $classMap);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;classMap = $classMap;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong>自动加载核心类 ClassLoader 的静态初始化到这里就完成了！</strong></p>
<p>其实说是5部分，真正重要的就两部分——初始化与注册。初始化负责顶层命名空间的目录映射，注册负责实现顶层以下的命名空间映射规则。</p>
<h3 id="第四部分-——-注册"><a href="#第四部分-——-注册" class="headerlink" title="第四部分 —— 注册"></a>第四部分 —— 注册</h3><hr>
<p>讲完了 Composer 自动加载功能的启动与初始化，经过启动与初始化，自动加载核心类对象已经获得了顶级命名空间与相应目录的映射，也就是说，如果有命名空间 ‘App\Console\Kernel，我们已经可以找到它对应的类文件所在位置。那么，它是什么时候被触发去找的呢？</p>
<p>这就是 composer 自动加载的核心了，我们先回顾一下自动加载引导类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    <span class="comment">/***************************经典单例模式********************/</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/***********************获得自动加载核心类对象********************/</span></span><br><span class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></span><br><span class="line"><span class="string">    7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line">    </span><br><span class="line">    spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></span><br><span class="line"><span class="string">    7b790917ce8899df9af8ed53631a1c29'</span>, <span class="string">'loadClassLoader'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***********************初始化自动加载核心类对象********************/</span></span><br><span class="line">    $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; </span><br><span class="line">    !defined(<span class="string">'HHVM_VERSION'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</span><br><span class="line"></span><br><span class="line">        call_user_func(\Composer\Autoload\ComposerStaticInit</span><br><span class="line">        <span class="number">7</span>b790917ce8899df9af8ed53631a1c29::getInitializer($loader));</span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">            $loader-&gt;set($namespace, $path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">            $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line">        <span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">            $loader-&gt;addClassMap($classMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***********************注册自动加载核心类对象********************/</span></span><br><span class="line">    $loader-&gt;register(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***********************自动加载全局函数********************/</span></span><br><span class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">        $includeFiles = Composer\Autoload\ComposerStaticInit</span><br><span class="line">        <span class="number">7</span>b790917ce8899df9af8ed53631a1c29::$files;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">        composerRequire</span><br><span class="line">        <span class="number">7</span>b790917ce8899df9af8ed53631a1c29($fileIdentifier, $file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们开始引导类的第四部分：注册自动加载核心类对象。我们来看看核心类的 register() 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($prepend = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'loadClass'</span>), <span class="keyword">true</span>, $prepend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一行代码实现自动加载！</p>
<p>其实奥秘都在自动加载核心类 ClassLoader 的 loadClass() 函数上：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($file = <span class="keyword">$this</span>-&gt;findFile($class)) &#123;</span><br><span class="line">            includeFile($file);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个函数负责按照 PSR 标准将顶层命名空间以下的内容转为对应的目录，也就是上面所说的将  ‘App\Console\Kernel 中’ Console\Kernel 这一段转为目录，至于怎么转的在下面 “运行”的部分讲。核心类 ClassLoader 将 loadClass() 函数注册到PHP SPL中的 spl_autoload_register() 里面去。这样，每当PHP遇到一个不认识的命名空间的时候，PHP会自动调用注册到 spl_autoload_register 里面的 loadClass() 函数，然后找到命名空间对应的文件。</p>
<h3 id="全局函数的自动加载"><a href="#全局函数的自动加载" class="headerlink" title="全局函数的自动加载"></a>全局函数的自动加载</h3><p> Composer 不止可以自动加载命名空间，还可以加载全局函数。怎么实现的呢？把全局函数写到特定的文件里面去，在程序运行前挨个 require就行了。这个就是 composer 自动加载的第五步，加载全局函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">    $includeFiles = Composer\Autoload\ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$files;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">    composerRequire7b790917ce8899df9af8ed53631a1c29($fileIdentifier, $file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟核心类的初始化一样，全局函数自动加载也分为两种：静态初始化和普通初始化，静态加载只支持PHP5.6以上并且不支持HHVM。</p>
<h4 id="静态初始化："><a href="#静态初始化：" class="headerlink" title="静态初始化："></a>静态初始化：</h4><p>  <code>ComposerStaticInit7b790917ce8899df9af8ed53631a1c29::$files：</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $files = <span class="keyword">array</span> (</span><br><span class="line"><span class="string">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring/bootstrap.php'</span>,</span><br><span class="line"><span class="string">'667aeda72477189d0494fecd327c3641'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/var-dumper/Resources/functions/dump.php'</span>,</span><br><span class="line">...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="普通初始化"><a href="#普通初始化" class="headerlink" title="普通初始化"></a>普通初始化</h4><p>autoload_files:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$vendorDir = dirname(dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">$baseDir = dirname($vendorDir);</span><br><span class="line">	</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> =&gt; $vendorDir . <span class="string">'/symfony/polyfill-mbstring/bootstrap.php'</span>,</span><br><span class="line"><span class="string">'667aeda72477189d0494fecd327c3641'</span> =&gt; $vendorDir . <span class="string">'/symfony/var-dumper/Resources/functions/dump.php'</span>,</span><br><span class="line">   ....</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其实跟静态初始化区别不大。</p>
<h4 id="加载全局函数"><a href="#加载全局函数" class="headerlink" title="加载全局函数"></a>加载全局函数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComposerAutoloaderInit7b790917ce8899df9af8ed53631a1c29</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span>&#123;</span><br><span class="line">	  ...</span><br><span class="line">	  <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">        composerRequire7b790917ce8899df9af8ed53631a1c29($fileIdentifier, $file);</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">composerRequire7b790917ce8899df9af8ed53631a1c29</span><span class="params">($fileIdentifier, $file)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(\$GLOBALS[<span class="string">'__composer_autoload_files'</span>][\$fileIdentifier])) &#123;</span><br><span class="line">        <span class="keyword">require</span> $file;</span><br><span class="line"></span><br><span class="line">        $GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第五部分-——-运行"><a href="#第五部分-——-运行" class="headerlink" title="第五部分 —— 运行"></a>第五部分 —— 运行</h4><p>到这里，终于来到了核心的核心—— composer 自动加载的真相，命名空间如何通过 composer 转为对应目录文件的奥秘就在这一章。<br>前面说过，ClassLoader 的 register() 函数将 loadClass() 函数注册到 PHP 的 SPL 函数堆栈中，每当 PHP 遇到不认识的命名空间时就会调用函数堆栈的每个函数，直到加载命名空间成功。所以 loadClass() 函数就是自动加载的关键了。</p>
<p> 看下 loadClass() 函数:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($file = <span class="keyword">$this</span>-&gt;findFile($class)) &#123;</span><br><span class="line">        includeFile($file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findFile</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// work around for PHP 5.3.0 - 5.3.2 https://bugs.php.net/50731</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'\\'</span> == $class[<span class="number">0</span>]) &#123;</span><br><span class="line">        $class = substr($class, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// class map lookup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;classMap[$class])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;classMap[$class];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;classMapAuthoritative) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.php'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Search for Hack files if we are running on HHVM</span></span><br><span class="line">    <span class="keyword">if</span> ($file === <span class="keyword">null</span> &amp;&amp; defined(<span class="string">'HHVM_VERSION'</span>)) &#123;</span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.hh'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($file === <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Remember that this class does not exist.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;classMap[$class] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 loadClass() ，主要调用 findFile() 函数。findFile() 在解析命名空间的时候主要分为两部分：classMap 和 findFileWithExtension() 函数。classMap 很简单，直接看命名空间是否在映射数组中即可。麻烦的是 findFileWithExtension() 函数，这个函数包含了 PSR0 和 PSR4 标准的实现。还有个值得我们注意的是查找路径成功后 includeFile() 仍然是外面的函数，并不是 ClassLoader 的成员函数，原理跟上面一样，防止有用户写 $this 或 self。还有就是如果命名空间是以\开头的，要去掉\然后再匹配。</p>
<p> 看下 findFileWithExtension 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">findFileWithExtension</span><span class="params">($class, $ext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// PSR-4 lookup</span></span><br><span class="line">	$logicalPathPsr4 = strtr($class, <span class="string">'\\'</span>, DIRECTORY_SEPARATOR) . $ext;</span><br><span class="line">	</span><br><span class="line">	$first = $class[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$first])) &#123;</span><br><span class="line">	    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$first] <span class="keyword">as</span> $prefix =&gt; $length) &#123;</span><br><span class="line">	        <span class="keyword">if</span> (<span class="number">0</span> === strpos($class, $prefix)) &#123;</span><br><span class="line">	            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixDirsPsr4[$prefix] <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">	                <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . substr($logicalPathPsr4, $length))) &#123;</span><br><span class="line">	                    <span class="keyword">return</span> $file;</span><br><span class="line">	                &#125;</span><br><span class="line">	            &#125;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PSR-4 fallback dirs</span></span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fallbackDirsPsr4 <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr4)) &#123;</span><br><span class="line">	        <span class="keyword">return</span> $file;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PSR-0 lookup</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">false</span> !== $pos = strrpos($class, <span class="string">'\\'</span>)) &#123;</span><br><span class="line">	    <span class="comment">// namespaced class name</span></span><br><span class="line">	    $logicalPathPsr0 = substr($logicalPathPsr4, <span class="number">0</span>, $pos + <span class="number">1</span>)</span><br><span class="line">	        . strtr(substr($logicalPathPsr4, $pos + <span class="number">1</span>), <span class="string">'_'</span>, DIRECTORY_SEPARATOR);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">// PEAR-like class name</span></span><br><span class="line">	    $logicalPathPsr0 = strtr($class, <span class="string">'_'</span>, DIRECTORY_SEPARATOR) . $ext;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixesPsr0[$first])) &#123;</span><br><span class="line">	    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixesPsr0[$first] <span class="keyword">as</span> $prefix =&gt; $dirs) &#123;</span><br><span class="line">	        <span class="keyword">if</span> (<span class="number">0</span> === strpos($class, $prefix)) &#123;</span><br><span class="line">	            <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">	                <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) &#123;</span><br><span class="line">	                    <span class="keyword">return</span> $file;</span><br><span class="line">	                &#125;</span><br><span class="line">	            &#125;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PSR-0 fallback dirs</span></span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fallbackDirsPsr0 <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) &#123;</span><br><span class="line">	        <span class="keyword">return</span> $file;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PSR-0 include paths.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;useIncludePath &amp;&amp; $file = stream_resolve_include_path($logicalPathPsr0)) &#123;</span><br><span class="line">	    <span class="keyword">return</span> $file;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="最后小结"><a href="#最后小结" class="headerlink" title="最后小结"></a>最后小结</h4><p>我们通过举例来说下上面代码的流程：</p>
<p>如果我们在代码中写下 <code>new phpDocumentor\Reflection\Element()</code>，PHP 会通过 SPL_autoload_register 调用 loadClass -&gt; findFile -&gt; findFileWithExtension。步骤如下：</p>
<blockquote>
<ul>
<li>将 \ 转为文件分隔符/，加上后缀php，变成 $logicalPathPsr4, 即 phpDocumentor/Reflection//Element.php;</li>
<li>利用命名空间第一个字母p作为前缀索引搜索 prefixLengthsPsr4 数组，查到下面这个数组：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p<span class="string">' =&gt; </span></span><br><span class="line"><span class="string">       array (</span></span><br><span class="line"><span class="string">           '</span>phpDocumentor\\Reflection\\<span class="string">' =&gt; 25,</span></span><br><span class="line"><span class="string">           '</span>phpDocumentor\\Fake\\<span class="string">' =&gt; 19,</span></span><br><span class="line"><span class="string">     )</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>遍历这个数组，得到两个顶层命名空间 phpDocumentor\Reflection\ 和 phpDocumentor\Fake\</li>
<li>在这个数组中查找 phpDocumentor\Reflection\Element，找出 phpDocumentor\Reflection\ 这个顶层命名空间并且长度为25。</li>
<li>在prefixDirsPsr4 映射数组中得到phpDocumentor\Reflection\ 的目录映射为：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; </span><br><span class="line">       <span class="keyword">array</span> (</span><br><span class="line">           <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-common/src'</span>,</span><br><span class="line">           <span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/type-resolver/src'</span>,</span><br><span class="line">           <span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-docblock/src'</span>,</span><br><span class="line">       ),</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>遍历这个映射数组，得到三个目录映射；</li>
<li>查看 “目录+文件分隔符//+substr(\$logicalPathPsr4, \$length)”文件是否存在，存在即返回。这里就是<br><code>&#39;__DIR__/../phpdocumentor/reflection-common/src + substr(phpDocumentor/Reflection/Element.php,25)&#39;</code></li>
<li>如果失败，则利用 fallbackDirsPsr4 数组里面的目录继续判断是否存在文件</li>
</ul>
</blockquote>
<hr>
<h4 id="The-end-Thanks"><a href="#The-end-Thanks" class="headerlink" title="The end. Thanks!"></a>The end. Thanks!</h4></div></article></div></main><footer><div class="paginator"><a href="/2018/07/10/Linux-performance-monitor/" class="prev">上一篇</a><a href="/2018/04/20/late-static-bindings/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'jofeechen';
var disqus_identifier = '2018/05/17/composer-autoload/';
var disqus_title = '深入解析 composer 的自动加载原理';
var disqus_url = 'http://www.tenpercent.top/2018/05/17/composer-autoload/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//jofeechen.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2019 <a href="http://www.tenpercent.top">Jeffrey</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-146782675-1",'auto');ga('send','pageview');</script></body></html>